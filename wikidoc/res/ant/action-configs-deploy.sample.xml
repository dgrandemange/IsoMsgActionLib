	<!--
		Needs the following properties to be set :
		* isoaction.config.deploy.dir : for instance, "modules/mygateway/cfg/isoaction/"
		* isoaction.config.work.dir : for instance, "modules/mygateway/action-configs/"
		* isoactionmsg.lib.location : path to the isomsgaction library jar
	-->
	<target name="deploy-action-configs">

		<delete>
			<fileset dir="${isoaction.config.deploy.dir}">
				<include name="**/*.xml" />
			</fileset>
		</delete>

		<fileset id="mapping.files" dir="${isoaction.config.work.dir}">
			<include name="*.xml" />
		</fileset>

		<copy todir="${isoaction.config.deploy.dir}" flatten="true">
			<fileset refid="mapping.files" />
		</copy>

		<pathconvert pathsep="${line.separator}" property="xinclude.mapping.files" refid="mapping.files">
			<mapper>
				<chainedmapper>
					<flattenmapper />
					<regexpmapper from="(^.*$)" to='&lt;xi:include href="cfg/isoaction/\1"/&gt;' />
				</chainedmapper>
			</mapper>
		</pathconvert>

		<copy todir="${isoaction.config.deploy.dir}/"> 
			<zipfileset src="${isoactionmsg.lib.location}" includes="org/jpos/jposext/isomsgaction/template/isoaction-main-template.xml" />
		</copy>
		
		<move file="${isoaction.config.deploy.dir}/org/jpos/jposext/isomsgaction/template/isoaction-main-template.xml" toFile="${isoaction.config.deploy.dir}/isoaction-main.xml" />
		
		<replace file="${isoaction.config.deploy.dir}/isoaction-main.xml" token="#INCLUSIONS_TOKEN#" value="${xinclude.mapping.files}" />

		<fileset id="common.mapping.files" dir="${isoaction.config.work.dir}/common">
			<include name="*.xml" />
		</fileset>

		<copy todir="${isoaction.config.deploy.dir}/common" flatten="true">
			<fileset refid="common.mapping.files" />
		</copy>

	</target>